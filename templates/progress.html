{% extends "layout.html" %}
{% block title %}Processing...{% endblock %}

{% block content %}
<div class="card">
    <div class="card-header">
        Step 3: Processing in Progress...
    </div>
    <div class="card-body">
        <p>Your request is being processed. Please do not close this window.</p>
        
        <div class="progress" style="height: 25px;">
            <div id="progress-bar" class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">0%</div>
        </div>
        
        <div id="status-text" class="mt-3 text-muted">
            Initializing...
        </div>

        <div id="error-alert" class="alert alert-danger mt-3" style="display: none;">
            An error occurred.
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const progressBar = document.getElementById('progress-bar');
        const statusText = document.getElementById('status-text');
        const errorAlert = document.getElementById('error-alert');

        function updateStatus() {
            fetch("{{ url_for('status') }}")
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        errorAlert.style.display = 'block';
                        errorAlert.textContent = 'Error: ' + data.error;
                        progressBar.classList.add('bg-danger');
                        statusText.textContent = 'Processing failed.';
                        return; // Stop polling
                    }

                    let percentage = 0;
                    if (data.total > 0) {
                        percentage = (data.progress / data.total) * 100;
                    }
                    
                    progressBar.style.width = percentage + '%';
                    progressBar.textContent = Math.round(percentage) + '%';
                    progressBar.setAttribute('aria-valuenow', percentage);
                    
                    statusText.textContent = data.current_task;

                    if (data.is_running) {
                        setTimeout(updateStatus, 2000); // Poll every 2 seconds
                    } else {
                        // Job finished
                        progressBar.classList.remove('progress-bar-animated');
                        if (percentage >= 100 || data.current_task.includes("completed")) {
                            progressBar.classList.add('bg-success');
                            statusText.innerHTML = '<strong>Processing complete!</strong> Redirecting to results...';
                            window.location.href = "{{ url_for('results') }}";
                        }
                    }
                })
                .catch(err => {
                    errorAlert.style.display = 'block';
                    errorAlert.textContent = 'Failed to get status. Check the console for details.';
                    console.error('Status fetch error:', err);
                });
        }

        // Start polling
        updateStatus();
    });
</script>
{% endblock %}
